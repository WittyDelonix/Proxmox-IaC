---
- name: Install Python pip
  apt:
    name:
      - python3
      - python3-pip
      - python3-venv
    state: present

- name: Create self-healing service directory
  file:
    path: /opt/self-healing
    state: directory
    mode: '0755'

- name: Copy self-healing service script
  copy:
    src: ../../../../self-healing-service/self_healing.py
    dest: /opt/self-healing/self_healing.py
    mode: '0755'

- name: Copy requirements file
  copy:
    src: ../../../../self-healing-service/requirements.txt
    dest: /opt/self-healing/requirements.txt
    mode: '0644'

- name: Install Python dependencies
  pip:
    requirements: /opt/self-healing/requirements.txt
    executable: pip3
    extra_args: --break-system-packages

- name: Create VM mapping file
  template:
    src: vm_mapping.json.j2
    dest: /opt/self-healing/vm_mapping.json
    mode: '0644'

- name: Create environment file for self-healing service
  template:
    src: self-healing.env.j2
    dest: /opt/self-healing/self-healing.env
    mode: '0600'

- name: Create systemd service for self-healing
  template:
    src: self-healing.service.j2
    dest: /etc/systemd/system/self-healing.service
    mode: '0644'
  notify:
    - reload systemd
    - restart self-healing

- name: Enable and start self-healing service
  systemd:
    name: self-healing
    enabled: yes
    state: started

- name: Create log directory
  file:
    path: /var/log
    state: directory
    mode: '0755'

- name: Create log rotation configuration
  copy:
    dest: /etc/logrotate.d/self-healing
    content: |
      /var/log/self-healing.log {
          daily
          rotate 7
          compress
          delaycompress
          missingok
          notifempty
          create 0644 root root
      }
    mode: '0644'
